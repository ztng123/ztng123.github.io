---
layout: post
title: ğŸ“ OAuth 2.0 êµ¬ê¸€ íšŒì›ê°€ì…
tags: [spring,google]
---

&nbsp;

&nbsp;

Google ê³„ì •ìœ¼ë¡œ íšŒì› ê°€ì…í•´ DBì— íšŒì› ì •ë³´ ì €ì¥í•˜ê¸°

---

## ğŸ”— API ë“±ë¡

#### OAuth 2.0 í´ë¼ì´ì–¸íŠ¸ ID ìƒì„±

1. [ì‚¬ìš©ì ì¸ì¦ ì •ë³´](https://console.cloud.google.com/apis/credentials?hl=ko&_ga=2.108419079.467097148.1690425194-107950802.1690422893) ì— ë“¤ì–´ê°€ê¸°
   

&nbsp;

&nbsp;

2. OAuth í´ë¼ì´ì–¸íŠ¸ ID ìƒì„±

&nbsp;

<img width="437" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2023-07-27 á„‹á…©á„’á…® 1 16 20" src="https://github.com/spring-projects/spring-security-samples/assets/53010592/bc208424-9861-4325-9294-dd266d07609e">

&nbsp;

&nbsp;

3. ì…ë ¥

&nbsp;

<img width="534" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2023-07-27 á„‹á…©á„’á…® 5 37 56" src="https://github.com/spring-projects/spring-security-samples/assets/53010592/5b2eb9cb-ca70-4e45-995b-7cdb6e531366">

- ë¦¬ë‹¤ì´ë ‰íŠ¸ URI ì„¤ì •

  ```
  http://localhost:8080/login/oauth2/code/google
  ```

&nbsp;

&nbsp;

#### application.properties êµ¬ì„±

&nbsp;

```properties
spring.datasource.driver-class-name= com.mysql.cj.jdbc.Driver
spring.datasource.url=jdbc:mysql://localhost:3306/[DBì´ë¦„]?characterEncoding=UTF-8&serverTimezone=Asia/Seoul
spring.datasource.username=[ìœ ì €ì´ë¦„]
spring.datasource.password=[ë¹„ë°€ë²ˆí˜¸]
spring.jpa.hibernate.ddl-auto=update
spring.profiles.include=oauth
spring.security.oauth2.client.registration.google.client-id=[ìƒì„±í•œ í´ë¼ì´ì–¸íŠ¸ ID]
spring.security.oauth2.client.registration.google.client-secret=[í´ë¼ì´ì–¸íŠ¸ ë¹„ë°€ë²ˆí˜¸]
spring.security.oauth2.client.registration.google.scope=email,profile
```

&nbsp;

ìƒì„±í•œ í´ë¼ì´ì–¸íŠ¸ ID,ë¹„ë°€ë²ˆí˜¸ë¡œ ìˆ˜ì •

&nbsp;

&nbsp;

#### login.html

&nbsp;

login.htmlì— ì¶”ê°€í•´ í´ë¦­í•˜ë©´ êµ¬ê¸€ ë¡œê·¸ì¸

&nbsp;

```html
<a href="/oauth2/authorization/google">êµ¬ê¸€ ë¡œê·¸ì¸</a>
```

&nbsp;

&nbsp;

### User

êµ¬ê¸€ ì‚¬ìš©ì ì •ë³´ ê´€ë¦¬

&nbsp;

&nbsp;

#### ğŸ“Œ OAuthUser

&nbsp;

UserDetailsë¡œ ì‚¬ìš©ì ì¸ì¦ ì •ë³´ì˜ ê´€ë¦¬

&nbsp;

```java
@Entity
@Data
@Getter
@Setter
@Table(name = "users")
@NoArgsConstructor(access = AccessLevel.PROTECTED)
public class OAuthUser implements UserDetails{

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "id")
    private Long id;

    @Column(name = "username")
    private String name;

    @Column(name = "email")
    private String email;

    @Column(name = "picture")
    private String picture;



    @Builder
    public OAuthUser(String name, String email) {
        this.name = name;
        this.email = email;
    }

    public OAuthUser update(String name, String picture) {
        this.name = name;
        this.picture = picture;

        return this;
    }




    public Collection<? extends GrantedAuthority> getAuthorities() {
        return List.of(new SimpleGrantedAuthority("user"));
    }

    @Override
    public String getUsername() {
        return name;
    }


    @Override
    public String getPassword() {
        return null;  // OAuth user does not have password
    }



    @Override
    public boolean isAccountNonExpired() {
        return true;  // or provide actual implementation
    }

    @Override
    public boolean isAccountNonLocked() {
        return true;  // or provide actual implementation
    }

    @Override
    public boolean isCredentialsNonExpired() {
        return true;  // or provide actual implementation
    }

    @Override
    public boolean isEnabled() {
        return true;  // or provide actual implementation
    }


}
```

&nbsp;

&nbsp;

#### ğŸ“Œ OAuthUserInfo

&nbsp;

OAuth2 ì¸ì¦ ê³¼ì •ì—ì„œ ì„œë²„ë¡œë¶€í„° ë°›ì•„ì˜¨ ì‚¬ìš©ì ì •ë³´ë¥¼ ì €ì¥í•˜ê³  ê´€ë¦¬

&nbsp;

```java
public class OAuth2UserInfo implements OAuth2User {

    private OAuthUser user;
    private Map<String, Object> attributes;

    public OAuth2UserInfo(OAuthUser user,Map<String, Object> attributes) {
        this.user = user;
        this.attributes = attributes;
    }





    @Override
    public Map<String, Object> getAttributes() {
        return attributes;
    }

    @Override
    public Collection<? extends GrantedAuthority> getAuthorities() {
        return user.getAuthorities();
    }


    @Override
    public String getName() {
        return user.getUsername();
    }
}
```

&nbsp;

> `Map<String, Object> getAttributes()` : ì‚¬ìš©ìì˜ ì†ì„± ë§µ ë°˜í™˜
> `Collection<? extends GrantedAuthority> getAuthorities()` : ì‚¬ìš©ìì˜ ê¶Œí•œ ëª©ë¡ì„ ë°˜í™˜

&nbsp;

&nbsp;

### UserRepository

&nbsp;

#### ğŸ“Œ OAuthUserRepository

&nbsp;

```java
public interface OAuthUserRepository extends JpaRepository<OAuthUser, Long> {
    Optional<OAuthUser> findByEmail(String email);
}
```

&nbsp;

- Spring Data JPAê°€ ì œê³µí•˜ëŠ” ë©”ì„œë“œë¥¼ ì‚¬ìš© ê°€ëŠ¥
- í•„ìš”í•œ ì¿¼ë¦¬ ë©”ì„œë“œë¥¼ ì„ ì–¸í•˜ë©´ Spring Data JPAê°€ í•´ë‹¹ ë©”ì„œë“œë¥¼ ìë™ìœ¼ë¡œ êµ¬í˜„

&nbsp;

&nbsp;

### Service

&nbsp;

OAuth2ë¥¼ í†µí•´ ë°›ì•„ì˜¨ ì‚¬ìš©ì ì •ë³´ë¥¼ ì²˜ë¦¬í•˜ê³ ,ìƒˆë¡œìš´ ì‚¬ìš©ìë¥¼ ìƒì„±í•˜ê±°ë‚˜ ê¸°ì¡´ ì‚¬ìš©ì ì •ë³´ ë¡œë“œ

&nbsp;

#### ğŸ“Œ OAuthUserDetailService

&nbsp;

```java
@RequiredArgsConstructor
@Service
public class OauthUserDetailService implements UserDetailsService {
    private final OAuthUserRepository userRepository;
    @Override
    public UserDetails loadUserByUsername(String email) {
        return userRepository.findByEmail(email)
                .orElseThrow(() -> new IllegalArgumentException(email));
    }
}
```

&nbsp;

ì´ë©”ì¼ì„ ê¸°ë°˜ìœ¼ë¡œ ì‚¬ìš©ìë¥¼ ì°¾ê¸°

&nbsp;

&nbsp;

#### ğŸ“Œ OAuthUserService

&nbsp;

```java
@RequiredArgsConstructor
@Service
public class OauthUserService extends DefaultOAuth2UserService {

    private final OAuthUserRepository userRepository;

    @Transactional
    @Override
    public OAuth2User loadUser(OAuth2UserRequest userRequest) throws OAuth2AuthenticationException {
        OAuth2User oAuth2User = super.loadUser(userRequest);

        String email = oAuth2User.getAttribute("email");

        Optional<OAuthUser> optionalUser = userRepository.findByEmail(email);
        OAuthUser user;

        if(optionalUser.isEmpty()) {
            user = OAuthUser.builder()
                    .name(oAuth2User.getAttribute("name"))
                    .email(oAuth2User.getAttribute("email"))
                    .build();
            userRepository.save(user);
        } else {
            user = optionalUser.get();
        }

        return new OAuth2UserInfo(user, oAuth2User.getAttributes());
    }
}
```

&nbsp;

ì‚¬ìš©ì ì •ë³´ë¥¼ ë¡œë“œí•˜ê³  í•´ë‹¹ ì´ë©”ì¼ê³¼ ë™ì¼í•œ ìœ ì € ì—†ë‹¤ë©´ DBì— ì €ì¥

&nbsp;

&nbsp;

### SecurityConfig

#### ğŸ“Œ WebSecurityConfig

```java
@RequiredArgsConstructor
@Configuration
public class WebSecurityConfig {

    private final UserDetailService userService;

    private final PasswordEncoder passwordEncoder;

    private final OauthUserService oauthUserService;


    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        return http
                // . . .
                .oauth2Login(oauth2 -> oauth2
                        .loginPage("/login")
                        .userInfoEndpoint(userInfo -> userInfo
                                .userService(oauthUserService))
                        .redirectionEndpoint(redirection -> redirection
                                .baseUri("/login/oauth2/code/google"))
                        .permitAll())
                .logout((logout) -> logout
                        .logoutSuccessUrl("/login"))
                .csrf(AbstractHttpConfigurer::disable)
                .build();
    }
```

&nbsp;

&nbsp;

### âš ï¸ OAuthUserService ì˜¤ë¥˜

&nbsp;

êµ¬ê¸€ ë¡œê·¸ì¸ì€ ë˜ì§€ë§Œ DBì— ì €ì¥ ë˜ì§€ ì•ŠìŒ

ğŸ‘‰ í™•ì¸í•´ë³´ë‹ˆ loadUser()ê°€ í˜¸ì¶œë˜ì§€ ì•Šì•„ ì €ì¥ X

&nbsp;

&nbsp;

#### â—ï¸ scopeì— openidê°€ í¬í•¨ëœ ê²ƒì´ ë¬¸ì œ

&nbsp;

openidë¥¼ ìš”ì²­í•˜ë©´ OIDC ë°©ì‹ì„ ì‚¬ìš©í•´ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¨ë‹¤
ì´ ë•Œ ì‚¬ìš©ì ì •ë³´ê°€ ID í† í°ì— ì´ë¯¸ í¬í•¨ë˜ì–´ ìˆì–´ì„œ ë³„ë„ì˜ "userinfo" ì—”ë“œí¬ì¸íŠ¸ í˜¸ì¶œì´ í•„ìš” ì—†ë‹¤ë©´ ìƒëµë˜ëŠ” ê²ƒ

&nbsp;

> `OIDC` : OAuth2.0 ì„ ê¸°ë°˜ìœ¼ë¡œ ì‚¬ìš©ì ì‹ ì›ì„ ì¸ì¦í•˜ëŠ” ë° ì‚¬ìš©
> ì‚¬ìš©ì ì •ë³´ë¥¼ í¬í•¨í•œ IDí† í°ì„ ì´ìš©í•˜ì—¬ ì‚¬ìš©ì í™•ì¸

&nbsp;

> `OAUth2.0` : ê¶Œí•œë¶€ì—¬ë¥¼ í†µí•´ ì•¡ì„¸ìŠ¤ í† í° ì–»ì–´ userinfo ì—”ë“œí¬ì¸íŠ¸ í˜¸ì¶œí•˜ì—¬ ì‚¬ìš©ì ì •ë³´ ì¶”ì¶œ

&nbsp;

&nbsp;

ğŸ“Œ application.properties

```properties
spring.security.oauth2.client.registration.google.scope=openid,email,profile
```

&nbsp;

&nbsp;

ğŸ“Œ scope

|  Scope  |                                     Claim                                      |
| :-----: | :----------------------------------------------------------------------------: |
| openid  | iss,sub,aud,name,nickname,family_name,given_name,birthdate,email,picture . . . |
| profile |            name,family_name,given_name,middle_name,nickname,picture            |
|  email  |                              email,email_verified                              |

> `scope` : ì‚¬ìš©ìì˜ ì„¸ë¶€ ì •ë³´ì— ëŒ€í•œ ì ‘ê·¼ ê¶Œí•œì„ ì¸ì¦í•˜ëŠ” ë° ì‚¬ìš©

> `claim` : ìŠ¤ì½”í”„ê°€ ë°˜í™˜í•˜ëŠ” ì†ì„± ì§‘í•©

ì´ë¯¸ ì›í•˜ëŠ” ì‚¬ìš©ì ì •ë³´ê°€ IDí† í°ì— í¬í•¨ë˜ì–´ìˆê¸°ì— userinfo ì—”ë“œí¬ì¸íŠ¸ í˜¸ì¶œí•˜ì§€ ì•Šì•„ ë¬¸ì œê°€ ë°œìƒ

#### ğŸ”í•´ê²°ë°©ë²• 3ê°€ì§€

&nbsp;

âœ… OidcUserServiceë¥¼ ìƒì†

&nbsp;

OauthUserService ëŠ” DefaultOAuth2UserServiceë¥¼ ìƒì†ë°›ê³  ìˆëŠ” ìƒíƒœ
OIDC ë°©ì‹ì„ ì„ íƒí•œë‹¤ë©´ DefaultOAuth2UserService ëŒ€ì‹  OidcUserServiceë¥¼ ìƒì†ë°›ìœ¼ë©´ ëœë‹¤

&nbsp;

```java
public class OauthUserService extends OidcUserService {

    private final OAuthUserRepository userRepository;

    @Transactional
    @Override
    public OidcUser loadUser(OidcUserRequest userRequest) throws OAuth2AuthenticationException {
    OidcUser oidcUser = super.loadUser(userRequest);

    OidcIdToken idToken = userRequest.getIdToken();
    Map<String, Object> claims = idToken.getClaims();

    String email = (String) claims.get("email");
    Optional<OAuthUser> optionalUser = userRepository.findByEmail(email);
    OAuthUser user;

    if (optionalUser.isEmpty()) {
      user = OAuthUser.builder()
              .name((String) claims.get("name"))
              .email(email)
              .build();
      userRepository.save(user);
    } else {
      user = optionalUser.get();
    }

    oidcUser = new DefaultOidcUser(
            Collections.singleton(new OidcUserAuthority(idToken)),
            userRequest.getClientRegistration().getProviderDetails().getUserInfoEndpoint().getUserNameAttributeName(),
            claims
    );

    return oidcUser;
  }
}
```

&nbsp;

&nbsp;

âœ… scope ìˆ˜ì •

&nbsp;

OAuth2.0ë§Œ ì‚¬ìš©í•œë‹¤ë©´ scopeì—ì„œ openid ë¹¼ê¸°

&nbsp;

```properties
spring.security.oauth2.client.registration.google.scope=email,profile
```

&nbsp;

&nbsp;

âœ… ë‘ ê°€ì§€ ëª¨ë‘ êµ¬í˜„

OAuth 2.0 ,OIDC ëª¨ë‘ ì§€ì›í•˜ê¸° ìœ„í•´ ë‘ ì„œë¹„ìŠ¤ë¥¼ êµ¬í˜„
&nbsp;

ğŸ“Œ ì¸í„°í˜ì´ìŠ¤ì— ë‘ ê°œì˜ í´ë˜ìŠ¤ ë¬¶ê¸°

&nbsp;

```Java

public interface OAuth2Service {
    @Service
    @RequiredArgsConstructor
    public class OauthUserService extends DefaultOAuth2UserService {

    private final OAuthUserRepository userRepository;

    @Transactional
    @Override
    public OAuth2User loadUser(OAuth2UserRequest userRequest) throws OAuth2AuthenticationException {
        OAuth2User oAuth2User = super.loadUser(userRequest);

        String email = oAuth2User.getAttribute("email");

        Optional<OAuthUser> optionalUser = userRepository.findByEmail(email);
        OAuthUser user;

        if(optionalUser.isEmpty()) {
            user = OAuthUser.builder()
                    .name(oAuth2User.getAttribute("name"))
                    .email(oAuth2User.getAttribute("email"))
                    .build();
            userRepository.save(user);
        } else {
            user = optionalUser.get();
        }

        return new OAuth2UserInfo(user, oAuth2User.getAttributes());
    }
}
    @Service
    @RequiredArgsConstructor
    public class OauthUserService extends OidcUserService {

    private final OAuthUserRepository userRepository;

    @Override
    public OidcUser loadUser(OidcUserRequest userRequest) throws OAuth2AuthenticationException {
        OidcUser oidcUser = super.loadUser(userRequest);

        OidcIdToken idToken = userRequest.getIdToken();
    Map<String, Object> claims = idToken.getClaims();

    String email = (String) claims.get("email");
    Optional<OAuthUser> optionalUser = userRepository.findByEmail(email);
    OAuthUser user;

    if (optionalUser.isEmpty()) {
      user = OAuthUser.builder()
              .name((String) claims.get("name"))
              .email(email)
              .build();
      userRepository.save(user);
    } else {
      user = optionalUser.get();
    }

    oidcUser = new DefaultOidcUser(
            Collections.singleton(new OidcUserAuthority(idToken)),
            userRequest.getClientRegistration().getProviderDetails().getUserInfoEndpoint().getUserNameAttributeName(),
            claims
    );

    return oidcUser;
    }
    }
}

```

&nbsp;

&nbsp;

ğŸ“Œ SecurityFilterChain ìˆ˜ì •

```Java
@Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        return http
                // . . .
                .oauth2Login(oauth2 -> oauth2
                        .loginPage("/login")
                        .userInfoEndpoint(userInfo -> userInfo
                                .userService(oauthUserService)
                                .oidcUserService(oidcUserService)) //ì¶”ê°€
```

&nbsp;

&nbsp;

### ğŸ’¾ ì €ì¥ ê²°ê³¼

&nbsp;

<img width="787" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2023-08-03 á„‹á…©á„’á…® 5 52 33" src="https://github.com/codingspecialist/-Springboot-Security-OAuth2.0-V3/assets/53010592/c1a9a5e0-29b1-4f04-bd47-ca319b947281">

&nbsp;

ê¸°ì¡´ì— íšŒì›ê°€ì… + êµ¬ê¸€ë¡œ ê°€ì…

&nbsp;

&nbsp;

---

ì¶œì²˜:[GoogleAuthentication](https://developers.google.com/identity/gsi/web/guides/get-google-api-clientid?hl=ko), [SpringDocs](https://docs.spring.io/spring-security/reference/servlet/oauth2/index.html),[Github](https://github.com/opensearch-project/security/issues/2040),[auth0](https://auth0.com/docs/get-started/apis)
